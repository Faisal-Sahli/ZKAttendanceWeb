@model ZKAttendanceWeb.ViewModels.EmployeeDetailsViewModel

@{
    ViewData["Title"] = "تفاصيل الموظف";
}

<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }

    .details-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .card-header-custom {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-bottom: 2px solid #dee2e6;
    }

    .section-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: #495057;
        margin-bottom: 0;
        display: flex;
        align-items: center;
    }

        .section-title i {
            margin-left: 0.75rem;
            color: #667eea;
            font-size: 1.3rem;
        }

    .info-row {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
    }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row:hover {
            background: #f8f9fa;
        }

    .info-label {
        font-weight: 600;
        color: #6c757d;
        width: 200px;
        flex-shrink: 0;
    }

    .info-value {
        color: #212529;
        font-weight: 500;
    }

    .badge-large {
        padding: 0.5rem 1rem;
        font-size: 1rem;
        font-weight: 600;
    }

    .employee-header {
        text-align: center;
        padding: 2rem;
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-bottom: 3px solid #667eea;
    }

    .employee-avatar {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 3rem;
        font-weight: bold;
        border: 5px solid white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .employee-name {
        font-size: 1.8rem;
        font-weight: 700;
        color: #212529;
        margin-bottom: 0.5rem;
    }

    .employee-id {
        font-size: 1.2rem;
        color: #6c757d;
    }

    .action-buttons-details {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }

    /* ═══════════════════════════════════════════════════════════ */
    /* ✅ NEW: Styles للأجهزة والفروع في Details */
    /* ═══════════════════════════════════════════════════════════ */
    .devices-section {
        background: #f8f9fa;
        padding: 2rem;
    }

    .city-group {
        margin-bottom: 2rem;
    }

    .city-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }

    .city-name {
        font-weight: 700;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .city-stats {
        display: flex;
        gap: 1rem;
    }

    .city-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .branch-device-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

        .branch-device-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

    .branch-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .branch-name-section {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .branch-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .branch-text {
        display: flex;
        flex-direction: column;
    }

    .branch-code {
        font-weight: 700;
        font-size: 1.1rem;
        color: #212529;
    }

    .branch-name-text {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .device-count-badge {
        background: #e7f3ff;
        color: #0d6efd;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .devices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }

    .device-item {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s ease;
    }

        .device-item:hover {
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%);
            border-color: #0d6efd;
            transform: translateX(-3px);
        }

    .device-icon {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .device-details {
        flex: 1;
    }

    .device-name {
        font-weight: 700;
        color: #212529;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }

    .device-ip {
        color: #6c757d;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .device-serial {
        color: #6c757d;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    .no-devices-card {
        background: #fff3cd;
        border: 2px dashed #ffc107;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        color: #856404;
    }

        .no-devices-card i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

        .stat-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #212529;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>

<div class="container-fluid" dir="rtl">

    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-user me-2"></i>
                    تفاصيل الموظف
                </h2>
                <p class="mb-0 opacity-75">عرض جميع معلومات الموظف</p>
            </div>
            <a asp-action="Index" class="btn btn-light btn-lg">
                <i class="fas fa-arrow-right me-2"></i>
                العودة للقائمة
            </a>
        </div>
    </div>

    <!-- Employee Details -->
    <div class="details-card">

        <!-- Employee Header with Avatar -->
        <div class="employee-header">
            <div class="employee-avatar">
                @Model.Employee.EmployeeName?.Substring(0, 1).ToUpper()
            </div>
            <h3 class="employee-name">@Model.Employee.EmployeeName</h3>
            <p class="employee-id">
                <i class="fas fa-fingerprint me-2"></i>
                رقم الموظف: <strong>@Model.Employee.BiometricUserId</strong>
            </p>
            @if (Model.Employee.IsActive)
            {
                <span class="badge-large bg-success text-white">
                    <i class="fas fa-check-circle me-1"></i>
                    نشط
                </span>
            }
            else
            {
                <span class="badge-large bg-danger text-white">
                    <i class="fas fa-times-circle me-1"></i>
                    غير نشط
                </span>
            }
        </div>

        <!-- Basic Information -->
        <div class="card-header-custom">
            <h5 class="section-title">
                <i class="fas fa-id-card"></i>
                المعلومات الأساسية
            </h5>
        </div>
        <div class="p-0">
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-user me-2"></i>
                    اسم الموظف:
                </div>
                <div class="info-value">@Model.Employee.EmployeeName</div>
            </div>
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-fingerprint me-2"></i>
                    رقم البصمة:
                </div>
                <div class="info-value">
                    <span class="badge bg-primary">@Model.Employee.BiometricUserId</span>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(Model.Employee.SSN))
            {
                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-id-card me-2"></i>
                        رقم الهوية:
                    </div>
                    <div class="info-value">@Model.Employee.SSN</div>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.Employee.Title))
            {
                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-briefcase me-2"></i>
                        المسمى الوظيفي:
                    </div>
                    <div class="info-value">@Model.Employee.Title</div>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.Employee.Gender))
            {
                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-venus-mars me-2"></i>
                        الجنس:
                    </div>
                    <div class="info-value">
                        @(Model.Employee.Gender == "M" ? "ذكر" : "أنثى")
                    </div>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.Employee.PhoneNumber))
            {
                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-phone me-2"></i>
                        رقم الجوال:
                    </div>
                    <div class="info-value">@Model.Employee.PhoneNumber</div>
                </div>
            }
            @if (Model.Employee.BirthDate.HasValue)
            {
                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-birthday-cake me-2"></i>
                        تاريخ الميلاد:
                    </div>
                    <div class="info-value">@Model.Employee.BirthDate.Value.ToString("yyyy/MM/dd")</div>
                </div>
            }
            @if (Model.Employee.HireDate.HasValue)
            {
                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-calendar-alt me-2"></i>
                        تاريخ التعيين:
                    </div>
                    <div class="info-value">@Model.Employee.HireDate.Value.ToString("yyyy/MM/dd")</div>
                </div>
            }
        </div>

        <!-- Work Information -->
        <div class="card-header-custom mt-3">
            <h5 class="section-title">
                <i class="fas fa-building"></i>
                معلومات العمل
            </h5>
        </div>
        <div class="p-0">
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-sitemap me-2"></i>
                    القسم:
                </div>
                <div class="info-value">
                    @if (Model.Employee.Department != null)
                    {
                        <span class="badge bg-info text-white">@Model.Employee.Department.DepartmentName</span>
                    }
                    else
                    {
                        <span class="text-muted">غير محدد</span>
                    }
                </div>
            </div>
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-clock me-2"></i>
                    الدوام الافتراضي:
                </div>
                <div class="info-value">
                    @if (Model.Employee.DefaultShift != null)
                    {
                        <span class="badge bg-secondary">@Model.Employee.DefaultShift.ShiftName</span>
                    }
                    else
                    {
                        <span class="text-muted">غير محدد</span>
                    }
                </div>
            </div>
        </div>

        <!-- Attendance Settings -->
        <div class="card-header-custom mt-3">
            <h5 class="section-title">
                <i class="fas fa-cog"></i>
                إعدادات الحضور
            </h5>
        </div>
        <div class="p-0">
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-user-check me-2"></i>
                    مراقبة الحضور:
                </div>
                <div class="info-value">
                    @if (Model.Employee.CheckAttendance)
                    {
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>مفعل</span>
                    }
                    else
                    {
                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>معطل</span>
                    }
                </div>
            </div>
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-clock me-2"></i>
                    مراقبة التأخير:
                </div>
                <div class="info-value">
                    @if (Model.Employee.CheckLate)
                    {
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>مفعل</span>
                    }
                    else
                    {
                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>معطل</span>
                    }
                </div>
            </div>
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-door-open me-2"></i>
                    مراقبة الخروج المبكر:
                </div>
                <div class="info-value">
                    @if (Model.Employee.CheckEarly)
                    {
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>مفعل</span>
                    }
                    else
                    {
                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>معطل</span>
                    }
                </div>
            </div>
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-business-time me-2"></i>
                    احتساب الوقت الإضافي:
                </div>
                <div class="info-value">
                    @if (Model.Employee.CheckOvertime)
                    {
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>مفعل</span>
                    }
                    else
                    {
                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>معطل</span>
                    }
                </div>
            </div>
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-umbrella-beach me-2"></i>
                    مراقبة الإجازات:
                </div>
                <div class="info-value">
                    @if (Model.Employee.CheckHoliday)
                    {
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>مفعل</span>
                    }
                    else
                    {
                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>معطل</span>
                    }
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="card-header-custom mt-3">
            <h5 class="section-title">
                <i class="fas fa-info-circle"></i>
                معلومات النظام
            </h5>
        </div>
        <div class="p-0">
            <div class="info-row">
                <div class="info-label">
                    <i class="fas fa-calendar-plus me-2"></i>
                    تاريخ الإنشاء:
                </div>
                <div class="info-value">@Model.Employee.CreatedDate.ToString("yyyy/MM/dd hh:mm tt")</div>
            </div>
            @if (Model.Employee.ModifiedDate.HasValue)
            {
                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-calendar-check me-2"></i>
                        آخر تحديث:
                    </div>
                    <div class="info-value">@Model.Employee.ModifiedDate.Value.ToString("yyyy/MM/dd hh:mm tt")</div>
                </div>
            }
        </div>
    </div>

    <!-- ✅ قسم الأجهزة والفروع (NEW) -->
    <div class="details-card mt-4">
        <div class="card-header-custom">
            <h5 class="section-title">
                <i class="fas fa-network-wired"></i>
                أجهزة البصمة المرتبطة بالموظف
            </h5>
        </div>

        @if (Model.AssignedBranches?.Any() == true)
        {
            <div class="devices-section">
                <!-- Summary Statistics -->
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-icon">🏢</div>
                        <div class="stat-number">@Model.AssignedBranches.Count</div>
                        <div class="stat-label">فرع</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📱</div>
                        <div class="stat-number">@Model.AssignedBranches.Sum(b => b.Devices.Count)</div>
                        <div class="stat-label">جهاز بصمة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🌍</div>
                        <div class="stat-number">@Model.AssignedBranches.Select(b => b.City).Distinct().Count()</div>
                        <div class="stat-label">مدينة</div>
                    </div>
                </div>

                <!-- Branches Grouped by City -->
                @foreach (var cityGroup in Model.AssignedBranches.GroupBy(b => b.City ?? "غير محدد"))
                {
                    <div class="city-group">
                        <div class="city-header">
                            <div class="city-name">
                                <i class="fas fa-map-marker-alt"></i>
                                @cityGroup.Key
                            </div>
                            <div class="city-stats">
                                <span class="city-badge">
                                    <i class="fas fa-building me-1"></i>
                                    @cityGroup.Count() فرع
                                </span>
                                <span class="city-badge">
                                    <i class="fas fa-fingerprint me-1"></i>
                                    @cityGroup.Sum(b => b.Devices.Count) جهاز
                                </span>
                            </div>
                        </div>

                        @foreach (var branch in cityGroup)
                        {
                            <div class="branch-device-card">
                                <div class="branch-info-header">
                                    <div class="branch-name-section">
                                        <div class="branch-icon">
                                            <i class="fas fa-building"></i>
                                        </div>
                                        <div class="branch-text">
                                            <div class="branch-code">@branch.BranchCode</div>
                                            <div class="branch-name-text">@branch.BranchName</div>
                                        </div>
                                    </div>
                                    <div class="device-count-badge">
                                        <i class="fas fa-fingerprint me-1"></i>
                                        @branch.Devices.Count جهاز
                                    </div>
                                </div>

                                @if (branch.Devices.Any())
                                {
                                    <div class="devices-grid">
                                        @foreach (var device in branch.Devices)
                                        {
                                            <div class="device-item">
                                                <div class="device-icon">
                                                    <i class="fas fa-fingerprint"></i>
                                                </div>
                                                <div class="device-details">
                                                    <div class="device-name">@device.DeviceName</div>
                                                    <div class="device-ip">
                                                        <i class="fas fa-network-wired"></i>
                                                        @device.DeviceIP
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(device.SerialNumber))
                                                    {
                                                        <div class="device-serial">
                                                            <i class="fas fa-barcode"></i>
                                                            S/N: @device.SerialNumber
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        لا توجد أجهزة في هذا الفرع
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="p-4">
                <div class="no-devices-card">
                    <i class="fas fa-inbox"></i>
                    <h5 class="mb-2">لا توجد أجهزة مرتبطة</h5>
                    <p class="mb-0">
                        لم يتم ربط هذا الموظف بأي أجهزة بصمة حتى الآن.
                        <br />
                        يمكنك إضافة الأجهزة من صفحة التعديل.
                    </p>
                </div>
            </div>
        }
    </div>

    <!-- Action Buttons -->
    <div class="details-card mt-4">
        <div class="p-4 bg-light">
            <div class="action-buttons-details">
                <a asp-action="Edit" asp-route-id="@Model.Employee.EmployeeId" class="btn btn-warning btn-lg text-white">
                    <i class="fas fa-edit me-2"></i>
                    تعديل البيانات
                </a>
                <a asp-action="Index" class="btn btn-secondary btn-lg">
                    <i class="fas fa-arrow-right me-2"></i>
                    العودة للقائمة
                </a>
                <button type="button" class="btn btn-danger btn-lg" onclick="confirmDelete(@Model.Employee.EmployeeId, '@Model.Employee.EmployeeName')">
                    <i class="fas fa-trash me-2"></i>
                    حذف الموظف
                </button>
            </div>
        </div>
    </div>

</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    تأكيد الحذف
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" dir="rtl">
                <p>هل أنت متأكد من حذف الموظف: <strong id="employeeName"></strong>؟</p>
                <p class="text-danger mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    لا يمكن التراجع عن هذا الإجراء
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <form id="deleteForm" method="post" style="display:inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        حذف
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function confirmDelete(employeeId, employeeName) {
            document.getElementById('employeeName').textContent = employeeName;
            document.getElementById('deleteForm').action = '/Employees/Delete/' + employeeId;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }
    </script>
}
