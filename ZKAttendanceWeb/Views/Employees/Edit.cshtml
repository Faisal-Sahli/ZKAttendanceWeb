@model ZKAttendanceWeb.ViewModels.EmployeeFormViewModel

@{
    ViewData["Title"] = "تعديل موظف";
}

<style>
    .page-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }

    .form-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        padding: 2rem;
    }

    .form-section {
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

    .section-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: #495057;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
    }

        .section-title i {
            margin-left: 0.5rem;
            color: #f5576c;
        }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.625rem 0.875rem;
    }

        .form-control:focus, .form-select:focus {
            border-color: #f5576c;
            box-shadow: 0 0 0 0.2rem rgba(245, 87, 108, 0.25);
        }

    .form-check-label {
        font-weight: 500;
        color: #495057;
    }

    .btn-update {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 600;
        color: white;
    }

        .btn-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
            color: white;
        }

    /* ═══════════════════════════════════════════════════════════ */
    /* ✅ NEW: Styles للأجهزة والفروع */
    /* ═══════════════════════════════════════════════════════════ */
    .city-accordion .accordion-item {
        border: none;
        margin-bottom: 1rem;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .city-accordion .accordion-button {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        font-weight: 700;
        font-size: 1.05rem;
        padding: 1rem 1.5rem;
        border: none;
    }

        .city-accordion .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
            box-shadow: none;
        }

        .city-accordion .accordion-button:focus {
            box-shadow: none;
            border-color: transparent;
        }

        .city-accordion .accordion-button::after {
            filter: brightness(0) invert(1);
        }

    .city-accordion .accordion-body {
        padding: 1.5rem;
        background: #f8f9fa;
    }

    .branch-card {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

        .branch-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #f5576c;
        }

        .branch-card.has-selected-devices {
            border-color: #28a745;
            background: #f0fff4;
        }

    .branch-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e9ecef;
    }

    .branch-title {
        font-weight: 700;
        font-size: 1rem;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .branch-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-select-all-branch {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        font-weight: 600;
    }

    .device-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 0.75rem;
    }

    .device-checkbox-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

        .device-checkbox-item:hover {
            background: #e9ecef;
            border-color: #f5576c;
        }

        .device-checkbox-item.checked {
            background: #fff3cd;
            border-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.15);
        }

    .device-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .device-name {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }

    .device-details {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .stats-badges {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .stat-badge {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

        .stat-badge i {
            font-size: 1.2rem;
        }

        .stat-badge.selected {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

    .search-box {
        margin-bottom: 1.5rem;
    }

        .search-box input {
            border-radius: 25px;
            padding: 0.75rem 1.25rem;
            border: 2px solid #dee2e6;
        }

            .search-box input:focus {
                border-color: #f5576c;
                box-shadow: 0 0 0 0.2rem rgba(245, 87, 108, 0.15);
            }

    .no-devices-message {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
        font-style: italic;
    }

    .previously-selected-badge {
        background: #ffc107;
        color: #000;
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-right: 0.5rem;
    }

    .changes-indicator {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: #ffc107;
        color: #000;
        padding: 1rem 2rem;
        border-radius: 50px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        font-weight: 700;
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            bottom: -100px;
            opacity: 0;
        }

        to {
            bottom: 2rem;
            opacity: 1;
        }
    }
</style>

<div class="container-fluid" dir="rtl">

    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-user-edit me-2"></i>
                    تعديل موظف
                </h2>
                <p class="mb-0 opacity-75">تعديل بيانات الموظف: @Model.EmployeeName</p>
            </div>
            <a asp-action="Index" class="btn btn-light">
                <i class="fas fa-arrow-right me-2"></i>
                العودة للقائمة
            </a>
        </div>
    </div>

    <!-- Changes Indicator -->
    <div class="changes-indicator" id="changesIndicator">
        <i class="fas fa-exclamation-circle me-2"></i>
        تم تعديل الأجهزة - لا تنسى حفظ التغييرات
    </div>

    <!-- Form -->
    <div class="form-card">
        <form asp-action="Edit" method="post">
            <input type="hidden" asp-for="EmployeeId" />

            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

            <!-- Basic Information -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-id-card"></i>
                    المعلومات الأساسية
                </h5>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="BiometricUserId" class="form-label">رقم البصمة *</label>
                        <input asp-for="BiometricUserId" class="form-control" />
                        <span asp-validation-for="BiometricUserId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="EmployeeName" class="form-label">اسم الموظف *</label>
                        <input asp-for="EmployeeName" class="form-control" />
                        <span asp-validation-for="EmployeeName" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Title" class="form-label">المسمى الوظيفي</label>
                        <input asp-for="Title" class="form-control" placeholder="مثل: مهندس، محاسب" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Gender" class="form-label">الجنس</label>
                        <select asp-for="Gender" class="form-select">
                            <option value="">-- اختر --</option>
                            <option value="M">ذكر</option>
                            <option value="F">أنثى</option>
                        </select>
                        <span asp-validation-for="Gender" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="HireDate" class="form-label">تاريخ التعيين</label>
                        <input asp-for="HireDate" type="date" class="form-control" />
                        <span asp-validation-for="HireDate" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Work Information -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-briefcase"></i>
                    معلومات العمل
                </h5>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="DepartmentId" class="form-label">القسم *</label>
                        <select asp-for="DepartmentId" asp-items="ViewBag.Departments" class="form-select">
                            <option value="">-- اختر القسم --</option>
                        </select>
                        <span asp-validation-for="DepartmentId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="DefaultShiftId" class="form-label">الدوام الافتراضي</label>
                        <select asp-for="DefaultShiftId" asp-items="ViewBag.Shifts" class="form-select">
                            <option value="">-- اختر الدوام --</option>
                        </select>
                        <span asp-validation-for="DefaultShiftId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- ✅ قسم الفروع والأجهزة (UPDATED) -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-network-wired"></i>
                    أجهزة البصمة المرتبطة بالموظف
                </h5>

                <!-- Stats Badges -->
                <div class="stats-badges">
                    <div class="stat-badge" id="selectedDevicesCount">
                        <i class="fas fa-fingerprint text-warning"></i>
                        <span>محدد حالياً: <strong>0</strong> جهاز</span>
                    </div>
                    <div class="stat-badge" id="selectedBranchesCount">
                        <i class="fas fa-building text-success"></i>
                        <span>من: <strong>0</strong> فرع</span>
                    </div>
                    <div class="stat-badge" id="originalDevicesCount">
                        <i class="fas fa-history text-info"></i>
                        <span>محفوظ سابقاً: <strong>0</strong> جهاز</span>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="search-box">
                    <input type="text"
                           id="searchDevices"
                           class="form-control"
                           placeholder="🔍 البحث عن فرع أو جهاز..." />
                </div>

                <!-- Accordion: المدن → الفروع → الأجهزة -->
                @if (Model.BranchesByCity?.Any() == true)
                {
                    <div class="accordion city-accordion" id="cityAccordion">
                        @{
                            var cityIndex = 0;
                        }
                        @foreach (var cityGroup in Model.BranchesByCity)
                        {
                            var cityName = cityGroup.Key;
                            var branches = cityGroup.Value;
                            var cityId = $"city{cityIndex}";
                            var isFirstCity = cityIndex == 0;

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-@cityId">
                                    <button class="accordion-button @(isFirstCity ? "" : "collapsed")"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapse-@cityId"
                                            aria-expanded="@(isFirstCity ? "true" : "false")"
                                            aria-controls="collapse-@cityId">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        @cityName
                                        <span class="badge bg-light text-dark ms-3">@branches.Count فرع</span>
                                    </button>
                                </h2>
                                <div id="collapse-@cityId"
                                     class="accordion-collapse collapse @(isFirstCity ? "show" : "")"
                                     aria-labelledby="heading-@cityId"
                                     data-bs-parent="#cityAccordion">
                                    <div class="accordion-body">

                                        @foreach (var branch in branches)
                                        {
                                            var branchHasDevices = branch.Devices?.Any() == true;
                                            var selectedDevicesInBranch = branch.Devices?.Count(d => d.IsSelected) ?? 0;
                                            var hasPreviouslySelected = selectedDevicesInBranch > 0;

                                            <div class="branch-card @(hasPreviouslySelected ? "has-selected-devices" : "")"
                                                 data-branch-id="@branch.BranchId">
                                                <div class="branch-header">
                                                    <div class="branch-title">
                                                        <i class="fas fa-building text-danger"></i>
                                                        <span>@branch.BranchCode - @branch.BranchName</span>
                                                        <span class="badge bg-info text-white">@(branch.Devices?.Count ?? 0) جهاز</span>
                                                        @if (hasPreviouslySelected)
                                                        {
                                                            <span class="badge bg-success">@selectedDevicesInBranch محدد سابقاً</span>
                                                        }
                                                    </div>
                                                    <div class="branch-actions">
                                                        @if (branchHasDevices)
                                                        {
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-primary btn-select-all-branch"
                                                                    onclick="toggleBranchDevices(@branch.BranchId, true)">
                                                                <i class="fas fa-check-double"></i> تحديد الكل
                                                            </button>
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-secondary btn-select-all-branch"
                                                                    onclick="toggleBranchDevices(@branch.BranchId, false)">
                                                                <i class="fas fa-times"></i> إلغاء الكل
                                                            </button>
                                                        }
                                                    </div>
                                                </div>

                                                @if (branchHasDevices)
                                                {
                                                    <div class="device-list">
                                                        @foreach (var device in branch.Devices!)
                                                        {
                                                            <label class="device-checkbox-item @(device.IsSelected ? "checked" : "")"
                                                                   data-device-id="@device.DeviceId"
                                                                   data-branch-id="@branch.BranchId"
                                                                   data-device-name="@device.DeviceName"
                                                                   data-device-ip="@device.DeviceIP"
                                                                   data-originally-selected="@(device.IsSelected ? "true" : "false")">
                                                                <div class="form-check">
                                                                    <input type="checkbox"
                                                                           class="form-check-input device-checkbox"
                                                                           name="SelectedDeviceIds"
                                                                           value="@device.DeviceId"
                                                                           id="device_@device.DeviceId"
                                                                           @(device.IsSelected ? "checked" : "")
                                                                           data-branch-id="@branch.BranchId"
                                                                           data-originally-selected="@(device.IsSelected ? "true" : "false")" />
                                                                    <div class="device-info">
                                                                        <div class="device-name">
                                                                            @if (device.IsSelected)
                                                                            {
                                                                                <span class="previously-selected-badge">
                                                                                    <i class="fas fa-check"></i> محدد سابقاً
                                                                                </span>
                                                                            }
                                                                            @device.DeviceName
                                                                        </div>
                                                                        <div class="device-details">
                                                                            <i class="fas fa-network-wired"></i> @device.DeviceIP
                                                                            @if (!string.IsNullOrEmpty(device.SerialNumber))
                                                                            {
                                                                                <span class="ms-2">
                                                                                    <i class="fas fa-barcode"></i> @device.SerialNumber
                                                                                </span>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="no-devices-message">
                                                        <i class="fas fa-inbox"></i>
                                                        لا توجد أجهزة مرتبطة بهذا الفرع
                                                    </div>
                                                }
                                            </div>
                                        }

                                    </div>
                                </div>
                            </div>

                            cityIndex++;
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        لا توجد فروع أو أجهزة متاحة حالياً
                    </div>
                }

                <div class="alert alert-warning mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>تنبيه:</strong>
                    أي تغييرات على الأجهزة المحددة ستؤثر على سجلات الحضور المستقبلية. تأكد من مراجعة التغييرات قبل الحفظ.
                </div>
            </div>

            <!-- Attendance Settings -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-cog"></i>
                    إعدادات الحضور
                </h5>

                <div class="row g-3">
                    <div class="col-md-6 col-lg-4">
                        <div class="form-check form-switch">
                            <input asp-for="CheckAttendance" class="form-check-input" type="checkbox" />
                            <label asp-for="CheckAttendance" class="form-check-label">
                                تفعيل مراقبة الحضور
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-check form-switch">
                            <input asp-for="CheckLate" class="form-check-input" type="checkbox" />
                            <label asp-for="CheckLate" class="form-check-label">
                                تفعيل مراقبة التأخير
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-check form-switch">
                            <input asp-for="CheckEarly" class="form-check-input" type="checkbox" />
                            <label asp-for="CheckEarly" class="form-check-label">
                                تفعيل مراقبة الخروج المبكر
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-check form-switch">
                            <input asp-for="CheckOvertime" class="form-check-input" type="checkbox" />
                            <label asp-for="CheckOvertime" class="form-check-label">
                                تفعيل احتساب الإضافي
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-check form-switch">
                            <input asp-for="CheckHoliday" class="form-check-input" type="checkbox" />
                            <label asp-for="CheckHoliday" class="form-check-label">
                                تفعيل مراقبة الإجازات
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-check form-switch">
                            <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                            <label asp-for="IsActive" class="form-check-label">
                                تفعيل الموظف
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <a asp-action="Index" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>
                    إلغاء
                </a>
                <button type="submit" class="btn btn-update btn-lg">
                    <i class="fas fa-save me-2"></i>
                    تحديث البيانات
                </button>
            </div>
        </form>
    </div>

</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // ═══════════════════════════════════════════════════════════
        // ✅ JavaScript للأجهزة والفروع (EDIT VERSION)
        // ═══════════════════════════════════════════════════════════
        $(document).ready(function () {

            // حفظ الحالة الأصلية للأجهزة المحددة
            let originalSelectedDevices = [];
            $('.device-checkbox:checked').each(function() {
                originalSelectedDevices.push($(this).val());
            });

            // تحديث العدادات عند التحميل
            updateStats();
            updateOriginalCount();

            // عند تغيير أي checkbox
            $('.device-checkbox').on('change', function () {
                const label = $(this).closest('.device-checkbox-item');
                if ($(this).is(':checked')) {
                    label.addClass('checked');
                } else {
                    label.removeClass('checked');
                }
                updateStats();
                checkForChanges();
            });

            // عند الضغط على الـ label نفسه
            $('.device-checkbox-item').on('click', function (e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = $(this).find('.device-checkbox');
                    checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
                }
            });

            // البحث
            $('#searchDevices').on('keyup', function () {
                const searchTerm = $(this).val().toLowerCase();

                $('.branch-card').each(function () {
                    const branchText = $(this).find('.branch-title').text().toLowerCase();
                    let hasVisibleDevices = false;

                    $(this).find('.device-checkbox-item').each(function () {
                        const deviceName = $(this).data('device-name').toLowerCase();
                        const deviceIp = $(this).data('device-ip').toLowerCase();

                        if (deviceName.includes(searchTerm) || deviceIp.includes(searchTerm) || branchText.includes(searchTerm)) {
                            $(this).show();
                            hasVisibleDevices = true;
                        } else {
                            $(this).hide();
                        }
                    });

                    // إظهار/إخفاء الفرع
                    if (hasVisibleDevices || branchText.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });

                // فتح كل الـ accordion items عند البحث
                if (searchTerm.length > 0) {
                    $('.accordion-collapse').addClass('show');
                }
            });

            // فحص إذا كان هناك تغييرات
            function checkForChanges() {
                let currentSelectedDevices = [];
                $('.device-checkbox:checked').each(function() {
                    currentSelectedDevices.push($(this).val());
                });

                // مقارنة بسيطة
                const hasChanges =
                    originalSelectedDevices.length !== currentSelectedDevices.length ||
                    !originalSelectedDevices.every(id => currentSelectedDevices.includes(id));

                if (hasChanges) {
                    $('#changesIndicator').fadeIn();
                } else {
                    $('#changesIndicator').fadeOut();
                }
            }

            function updateOriginalCount() {
                $('#originalDevicesCount strong').text(originalSelectedDevices.length);
            }

        });

        // ═══════════════════════════════════════════════════════════
        // تحديد/إلغاء تحديد أجهزة فرع معين
        // ═══════════════════════════════════════════════════════════
        function toggleBranchDevices(branchId, selectAll) {
            $(`.device-checkbox[data-branch-id="${branchId}"]`).each(function () {
                $(this).prop('checked', selectAll).trigger('change');
            });
        }

        // ═══════════════════════════════════════════════════════════
        // تحديث العدادات
        // ═══════════════════════════════════════════════════════════
        function updateStats() {
            const selectedDevices = $('.device-checkbox:checked').length;
            const selectedBranches = new Set();

            $('.device-checkbox:checked').each(function () {
                const branchId = $(this).data('branch-id');
                selectedBranches.add(branchId);
            });

            $('#selectedDevicesCount strong').text(selectedDevices);
            $('#selectedBranchesCount strong').text(selectedBranches.size);

            // تحديث لون الـ badges
            if (selectedDevices > 0) {
                $('#selectedDevicesCount').addClass('selected');
                $('#selectedBranchesCount').addClass('selected');
            } else {
                $('#selectedDevicesCount').removeClass('selected');
                $('#selectedBranchesCount').removeClass('selected');
            }
        }

    </script>
}
